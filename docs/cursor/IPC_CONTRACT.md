# IPC_CONTRACT.md
## Flutter Client â†” Device Controller Service IPC Contract

> This document is the **single source of truth** for IPC between:
> - Flutter Kiosk Client
> - Device Controller Service (C++ Windows Service)
>
> Any implementation MUST strictly follow this contract.
> If there is a conflict, this document ALWAYS wins.

---

## 1. Scope & Transport

### Scope
- IPC is **local machine only**
- No external network exposure is allowed

### Transport
- Windows Named Pipes

### Encoding
- JSON (initial implementation)
- Protobuf may be adopted later
- Field names and semantics MUST remain identical regardless of encoding

---

## 2. Protocol Versioning

### protocolVersion
- REQUIRED in every message
- Format: "MAJOR.MINOR" (string), e.g. "1.0"

### Compatibility rules
- MINOR update:
  - Optional fields only
  - Backward compatible
- MAJOR update:
  - Breaking changes allowed

---

## 3. Communication Model

The protocol consists of three logical flows:

1. **Command / Response**
2. **Event Stream**
3. **State Snapshot**

---

## 4. Identifiers & Idempotency

### commandId
- REQUIRED for every Command
- Generated by Client
- Must be globally unique (UUID recommended)

### Idempotency rule
- Duplicate commandId MUST NOT re-execute logic
- Previous Response MUST be returned

### eventId
- Generated by Service
- Events MAY be duplicated or reordered

---

## 5. Common Types

### DeviceType
- "camera"
- "printer"
- "payment"

### Status
- "OK"
- "REJECTED"
- "FAILED"

### Error Object
{
  "code": "STRING_ENUM",
  "message": "short human-readable message",
  "details": {}
}

---

## 6. Message Schemas

### Command
{
  "protocolVersion": "1.0",
  "kind": "command",
  "commandId": "UUID",
  "type": "COMMAND_TYPE",
  "timestampMs": 0,
  "payload": {}
}

### Response
{
  "protocolVersion": "1.0",
  "kind": "response",
  "commandId": "UUID",
  "status": "OK",
  "timestampMs": 0,
  "error": null,
  "result": {}
}

### Event
{
  "protocolVersion": "1.0",
  "kind": "event",
  "eventId": "UUID",
  "eventType": "EVENT_TYPE",
  "timestampMs": 0,
  "deviceType": "camera",
  "data": {}
}

### Snapshot Request
{
  "protocolVersion": "1.0",
  "kind": "snapshot_request",
  "requestId": "UUID",
  "timestampMs": 0,
  "deviceTypes": []
}

### Snapshot Response
{
  "protocolVersion": "1.0",
  "kind": "snapshot_response",
  "requestId": "UUID",
  "timestampMs": 0,
  "snapshot": {}
}

---

## 7. Change Rules

- This file is immutable per version
- Any change requires protocolVersion update
