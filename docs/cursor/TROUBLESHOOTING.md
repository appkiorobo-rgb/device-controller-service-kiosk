# Device Controller Service - 트러블슈팅

## "Failed to read data failed. Error code: 5" 반복 출력

### 원인

- **에러 코드 5** = Windows `ERROR_ACCESS_DENIED` (접근 거부)
- Smartro 결제 단말과의 **시리얼(COM) 포트**에서 `ReadFile()`이 실패할 때 발생합니다.
- 수신 스레드(`responseReceiverThread`)가 100ms 간격으로 읽기를 시도하므로, 실패 시 **같은 에러가 반복 로그**됩니다.

### Error 5가 나는 대표적인 경우

1. **COM 포트가 다른 프로그램에 열려 있음**

   - Windows COM 포트는 한 프로세스만 열 수 있습니다.
   - 다른 앱(터미널, 테스트 툴, 이전에 띄운 서비스 등)이 해당 COM 포트를 사용 중이면 5가 납니다.

2. **Smartro 단말이 아님**

   - 가상 COM, 블루투스 시리얼, USB 시리얼 변환기 등 다른 장치가 같은 COM 번호를 쓰는 경우, 읽기에서 접근 거부가 날 수 있습니다.

3. **장치 연결 끊김**

   - 포트는 열린 상태인데 케이블/장치가 끊기면, 이후 `ReadFile()`에서 5가 발생할 수 있습니다.

4. **권한 부족**
   - 관리자 권한이 필요하거나, 해당 COM 포트에 대한 접근 권한이 없을 수 있습니다.

### 적용한 대응

- **로그 억제**: Error 5인 경우 **5초에 한 번만** 경고 로그를 남기도록 변경했습니다.
  - 위치: `src/vendor_adapters/smartro/serial_port.cpp`
  - 반복 출력은 사라지고, 원인 조사 시에는 “Serial read failed: Access denied (error 5)…” 메시지로 확인할 수 있습니다.

### 추가로 확인할 것

1. **다른 프로그램에서 COM 포트 사용 여부**

   - 장치 관리자에서 해당 COM 포트를 쓰는 프로세스가 있는지 확인하고, 필요 시 종료 후 서비스만 다시 실행해 보세요.

2. **Smartro 단말 연결**

   - 실제 결제 단말이 해당 COM 포트에 연결되어 있는지, 케이블/전원/드라이버가 정상인지 확인하세요.

3. **관리자 권한**

   - 서비스를 “관리자 권한으로 실행”해서 동일한 에러가 나는지 한 번 확인해 보세요.

4. **테스트 시**
   - 결제 단말이 없이 서비스만 실행하면, 열린 COM 포트가 Smartro가 아닐 가능성이 높아 Error 5가 날 수 있습니다.
   - 단말이 없을 때는 해당 COM 포트를 사용하지 않도록 설정하거나, 단말 연결 후 다시 테스트하는 것이 좋습니다.
